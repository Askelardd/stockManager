{% extends "management/base.html" %}

{% block title %}Trafilar Fio{% endblock %}

{% block content %}
<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">

  {% if messages %}
    <div class="space-y-2 mb-4">
      {% for message in messages %}
        <div class="rounded-lg px-4 py-3 text-sm
            {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% endif %}
            {% if message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200{% endif %}
            {% if message.tags == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% endif %}
            {% if message.tags == 'info' %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Selecionar origem -->
    <div class="lg:col-span-1 bg-white shadow-sm ring-1 ring-gray-100 rounded-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100">
        <h2 class="text-lg font-semibold text-gray-900">Selecionar Fio de Origem</h2>
      </div>
      <div class="p-5 space-y-3">
        <div class="text-sm text-gray-600">Escolha o fio a partir do qual o peso será repartido.</div>
        <div class="space-y-2 max-h-[420px] overflow-auto">
          {% for fio in fios %}
            <a href="{% url 'trafilar_fio' %}?origem_id={{ fio.id }}"
               class="block rounded-lg border px-3 py-2 hover:bg-gray-50
                      {% if origem and origem.id == fio.id %}border-blue-500 bg-blue-50{% else %}border-gray-200{% endif %}">
              <div class="flex items-center justify-between">
                <span class="font-medium text-gray-900">{{ fio.size }} mm</span>
                <span class="text-sm text-gray-600">{{ fio.get_material_display }}</span>
              </div>
              <div class="text-sm text-gray-700">Peso: <strong>{{ fio.weight }} g</strong> · Qtd: {{ fio.quantity }}</div>
            </a>
          {% empty %}
            <p class="text-sm text-gray-500">Sem fios cadastrados.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Form trafilar -->
    <div class="lg:col-span-2 bg-white shadow-sm ring-1 ring-gray-100 rounded-2xl overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Distribuir Peso para Destinos</h2>
        {% if origem %}
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-600">
              Origem: {{ origem.size }} mm · {{ origem.get_material_display }} · Disponível:
              <strong id="pesoDisponivel">{{ origem.weight }}</strong> g
            </span>
            <button type="button"
                    class="inline-flex items-center rounded-lg border border-blue-600 px-3 py-1.5 text-sm text-blue-700 font-semibold hover:bg-blue-50"
                    onclick="openNovoFioModal()">
              Novo destino
            </button>
          </div>
        {% endif %}
      </div>

      <div class="p-5">
        {% if not origem %}
          <p class="text-sm text-gray-600">Selecione um fio de origem ao lado para começar.</p>
        {% else %}
          <form method="post" class="space-y-4" oninput="calcTotal()">
            {% csrf_token %}
            <input type="hidden" name="origem_id" value="{{ origem.id }}"/>

            <div id="linhas" class="space-y-3">
              <!-- linha base -->
              <div class="linha grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                <div class="md:col-span-8">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Destino</label>
                  <select name="target_id[]" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
                    <option value="">Selecione…</option>
                    {% for d in destinos %}
                      <option value="{{ d.id }}">{{ d.size }} mm — Peso: {{ d.weight }} g</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="md:col-span-3">
                  <label class="block text-sm font-medium text-gray-700 mb-1">Peso a transferir (g)</label>
                  <input type="number" step="0.01" min="0" name="peso[]" class="w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500" placeholder="0.00" />
                </div>
                <div class="md:col-span-1">
                  <button type="button" class="w-full rounded-lg border border-gray-300 px-3 py-2 hover:bg-gray-50" onclick="removerLinha(this)">–</button>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-4 pt-2">
              <button type="button" onclick="adicionarLinha()"
                      class="inline-flex items-center rounded-lg border border-blue-600 px-3 py-2 text-blue-700 font-semibold hover:bg-blue-50">
                + Adicionar destino
              </button>
              <div class="ml-auto text-sm text-gray-700">
                Total a transferir: <strong id="totalTransferir">0.00</strong> g
                <span id="alertaExcede" class="ml-2 hidden text-red-600 font-semibold">Excede o disponível!</span>
              </div>
            </div>

            <div class="pt-3">
              <button type="submit"
                      class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-white font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Confirmar Transformação
              </button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% if origem %}
<div id="novoFioModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <!-- Overlay não clicável -->
  <div class="absolute inset-0 bg-black/40 pointer-events-none"></div>

  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-2xl rounded-2xl bg-white shadow-xl ring-1 ring-gray-100 relative z-10">
      <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Criar novo fio destino</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeNovoFioModal()">✕</button>
      </div>

      <form method="post" action="{% url 'criar_fio_rapido' %}" class="p-5 space-y-4">
        {% csrf_token %}
        <input type="hidden" name="origem_id" value="{{ origem.id }}">
        <input type="hidden" name="next" value="{{ request.get_full_path }}">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Material</label>
            <input type="text" value="{{ origem.get_material_display }}" disabled
                   class="block w-full rounded-lg border-gray-300 bg-gray-100">
          </div>

          <div>
            <label for="size" class="block text-sm font-medium text-gray-700 mb-1">Tamanho (mm)</label>
            <input type="number" step="0.0001" min="0" id="size" name="size" required
                   class="block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
          </div>

          <div>
            <label for="fornecedor" class="block text-sm font-medium text-gray-700 mb-1">Fornecedor</label>
            <select id="fornecedor" name="fornecedor" required
                    class="block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
              <option value="">Selecione…</option>
              {% for f in fornecedores %}
                <option value="{{ f.id }}">{{ f.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label for="min_stock" class="block text-sm font-medium text-gray-700 mb-1">Min. stock</label>
            <input type="number" min="0" id="min_stock" name="min_stock" value="0"
                   class="block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
          </div>

          <div>
            <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantidade inicial (opcional)</label>
            <input type="number" min="0" id="quantity" name="quantity" value="0"
                   class="block w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500">
          </div>
        </div>

        <div class="pt-2 flex items-center justify-end gap-3">
          <button type="button" class="rounded-lg border border-gray-300 px-4 py-2 text-gray-700 hover:bg-gray-50" onclick="closeNovoFioModal()">Cancelar</button>
          <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-white font-semibold hover:bg-blue-700">Criar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endif %}

<script>
  function adicionarLinha() {
    const linhas = document.getElementById('linhas');
    const base = linhas.querySelector('.linha');
    const nova = base.cloneNode(true);
    // limpa valores
    nova.querySelectorAll('select, input').forEach(el => {
      if (el.tagName === 'INPUT') el.value = '';
      else el.selectedIndex = 0;
    });
    linhas.appendChild(nova);
  }

    document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeNovoFioModal();
  });
  
  function removerLinha(btn) {
    const linhas = document.getElementById('linhas');
    const linha = btn.closest('.linha');
    if (linhas.children.length > 1) {
      linha.remove();
      calcTotal();
    }
  }
  function calcTotal() {
    const pesos = document.querySelectorAll('input[name="peso[]"]');
    let total = 0;
    pesos.forEach(i => {
      const v = parseFloat(i.value);
      if (!isNaN(v)) total += v;
    });
    const totalEl = document.getElementById('totalTransferir');
    if (totalEl) totalEl.textContent = total.toFixed(2);

    const dispEl = document.getElementById('pesoDisponivel');
    if (dispEl) {
      const disponivel = parseFloat(dispEl.textContent);
      const excede = total > disponivel;
      const alerta = document.getElementById('alertaExcede');
      if (alerta) alerta.classList.toggle('hidden', !excede);
    }
  }
  function openNovoFioModal() {
    document.getElementById('novoFioModal').classList.remove('hidden');
  }
  function closeNovoFioModal() {
    document.getElementById('novoFioModal').classList.add('hidden');
  }
  document.addEventListener('DOMContentLoaded', calcTotal);
</script>
{% endblock %}
